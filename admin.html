<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>좌석 인증 관리자 페이지</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .info {
            text-align: center;
            margin-bottom: 10px;
            color: #555;
        }
        table {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            border-collapse: collapse;
            background-color: #ffffff;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ccc;
            text-align: center;
            padding: 8px;
            font-size: 14px;
        }
        th {
            background-color: #eaeaea;
        }
        tbody tr:nth-child(even) {
            background-color: #fafafa;
        }
        .refresh-btn {
            display: block;
            margin: 10px auto 20px auto;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
        .empty-row {
            text-align: center;
            color: #777;
        }
        .delete-btn {
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
    </style>

    <script>
        // 사용자 삭제
        async function deleteUser(studentId) {
            if (!studentId) return;

            const ok = confirm(`${studentId} 사용자를 삭제하시겠습니까?`);
            if (!ok) return;

            try {
                const res = await fetch(`/api/admin/users/${encodeURIComponent(studentId)}`, {
                    method: "DELETE"
                });

                if (!res.ok) {
                    throw new Error("삭제 요청 실패");
                }

                alert("사용자 삭제가 완료되었습니다.");
                loadAdminUsers();
            } catch (err) {
                console.error("사용자 삭제 실패:", err);
                alert("사용자 삭제 중 오류가 발생했습니다.");
            }
        }

        async function loadAdminUsers() {
            const tbody = document.getElementById("admin-users-body");
            tbody.innerHTML = "";

            try {
                const res = await fetch("/api/admin/users");
                if (!res.ok) {
                    throw new Error("서버 응답 오류");
                }

                const users = await res.json();

                if (!users || users.length === 0) {
                    const row = document.createElement("tr");
                    row.innerHTML = "<td colspan='5' class='empty-row'>현재 인증된 사용자가 없습니다.</td>";
                    tbody.appendChild(row);
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement("tr");

                    const studentId = user.studentId || "";
                    const floor = user.floor || "";
                    const seatType = user.seatType || "";

                    let timeText = "";
                    if (user.time) {
                        const d = new Date(user.time);
                        timeText = d.toLocaleString("ko-KR");
                    }

                    row.innerHTML = `
                        <td>${studentId}</td>
                        <td>${floor}</td>
                        <td>${seatType}</td>
                        <td>${timeText}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteUser('${studentId}')">
                                삭제
                            </button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error("관리자 데이터 로드 실패:", err);
                const row = document.createElement("tr");
                row.innerHTML = "<td colspan='5' class='empty-row'>데이터를 불러오는 중 오류가 발생했습니다.</td>";
                tbody.appendChild(row);
            }
        }

        window.onload = function () {
            loadAdminUsers();
        };
    </script>
</head>
<body>
    <h1>좌석 인증 관리자 페이지</h1>
    <div class="info">
        현재 인증되어 있는 사용자 목록입니다. (만료된 사용자는 1시간 후 자동 제거)
    </div>
    <button class="refresh-btn" onclick="loadAdminUsers()">새로고침</button>

    <table>
        <thead>
            <tr>
                <th>학번</th>
                <th>층/열람실</th>
                <th>좌석 유형</th>
                <th>인증 시간</th>
                <th>삭제</th>
            </tr>
        </thead>
        <tbody id="admin-users-body">
        </tbody>
    </table>
</body>
</html>
